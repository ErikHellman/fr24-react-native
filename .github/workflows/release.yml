name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'

env:
  EXPO_PUBLIC_FR24_API_KEY: ${{ secrets.EXPO_PUBLIC_FR24_API_KEY }}
  EXPO_PUBLIC_GOOGLE_MAPS_API_KEY: ${{ secrets.EXPO_PUBLIC_GOOGLE_MAPS_API_KEY }}

jobs:
  # Build Android APK
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: npm ci

      - name: Generate native Android project
        run: npx expo prebuild --platform android --clean

      - name: Build Android APK (Release)
        working-directory: android
        run: |
          chmod +x gradlew
          ./gradlew assembleRelease

      - name: Sign APK
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > keystore.jks
          $ANDROID_HOME/build-tools/34.0.0/apksigner sign \
            --ks keystore.jks \
            --ks-pass pass:$ANDROID_KEYSTORE_PASSWORD \
            --ks-key-alias $ANDROID_KEY_ALIAS \
            --key-pass pass:$ANDROID_KEY_PASSWORD \
            --out fr24-android.apk \
            android/app/build/outputs/apk/release/app-release-unsigned.apk
          rm keystore.jks

      - name: Rename unsigned APK (if not signed)
        if: ${{ env.ANDROID_KEYSTORE_BASE64 == '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          cp android/app/build/outputs/apk/release/app-release-unsigned.apk fr24-android.apk

      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: fr24-android.apk
          retention-days: 1

  # Build iOS IPA
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate native iOS project
        run: npx expo prebuild --platform ios --clean

      - name: Install CocoaPods dependencies
        working-directory: ios
        run: pod install

      - name: Build iOS app (Simulator)
        run: |
          xcodebuild -workspace ios/fr24reactnative.xcworkspace \
            -scheme fr24reactnative \
            -configuration Release \
            -sdk iphonesimulator \
            -derivedDataPath build \
            CODE_SIGNING_ALLOWED=NO \
            build

      - name: Create iOS Simulator archive
        run: |
          cd build/Build/Products/Release-iphonesimulator
          zip -r ../../../../fr24-ios-simulator.zip fr24reactnative.app

      # For signed IPA builds (requires Apple Developer credentials)
      - name: Build iOS IPA (Device)
        if: ${{ env.IOS_CERTIFICATE_BASE64 != '' }}
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISION_PROFILE_BASE64: ${{ secrets.IOS_PROVISION_PROFILE_BASE64 }}
        run: |
          # Create keychain
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo "$IOS_CERTIFICATE_BASE64" | base64 -d > certificate.p12
          security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
          rm certificate.p12

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$IOS_PROVISION_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

          # Build archive
          xcodebuild -workspace ios/fr24reactnative.xcworkspace \
            -scheme fr24reactnative \
            -configuration Release \
            -sdk iphoneos \
            -archivePath build/fr24reactnative.xcarchive \
            archive

          # Export IPA
          xcodebuild -exportArchive \
            -archivePath build/fr24reactnative.xcarchive \
            -exportPath build/ipa \
            -exportOptionsPlist ios/ExportOptions.plist

          cp build/ipa/*.ipa fr24-ios.ipa

      - name: Upload iOS Simulator artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-simulator-build
          path: fr24-ios-simulator.zip
          retention-days: 1

      - name: Upload iOS IPA artifact
        if: ${{ env.IOS_CERTIFICATE_BASE64 != '' }}
        uses: actions/upload-artifact@v4
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        with:
          name: ios-ipa-build
          path: fr24-ios.ipa
          retention-days: 1

  # Create GitHub Release
  release:
    needs: [build-web, build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          cp artifacts/android-build/fr24-android.apk release-assets/
          cp artifacts/ios-simulator-build/fr24-ios-simulator.zip release-assets/
          # Copy signed IPA if available
          if [ -f artifacts/ios-ipa-build/fr24-ios.ipa ]; then
            cp artifacts/ios-ipa-build/fr24-ios.ipa release-assets/
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: FR24 React Native ${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') }}
          generate_release_notes: true
          files: |
            release-assets/*
          body: |
            ## Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | Android | `fr24-android.apk` | Android APK - install directly on Android devices |
            | iOS (Simulator) | `fr24-ios-simulator.zip` | iOS Simulator build - for testing on macOS |
            | iOS (Device) | `fr24-ios.ipa` | iOS IPA - for device installation (if signed) |

            ## Installation Instructions

            ### Android
            1. Download `fr24-android.apk`
            2. Enable "Install from unknown sources" on your device
            3. Install the APK

            ### iOS Simulator
            1. Extract `fr24-ios-simulator.zip`
            2. Drag the `.app` file to the iOS Simulator

            ### iOS Device
            Requires a signed IPA with proper provisioning. See project documentation for setup.

            ---
            *Built automatically by GitHub Actions*
